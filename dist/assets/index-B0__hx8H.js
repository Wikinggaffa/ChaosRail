var b=Object.defineProperty;var I=(s,t,e)=>t in s?b(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>I(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class L{constructor(t){r(this,"update");r(this,"render");r(this,"dt");r(this,"acc",0);r(this,"running",!1);r(this,"last",0);this.update=t.update,this.render=t.render;const e=t.simHz??20;this.dt=1/e}start(){if(this.running)return;this.running=!0,this.last=performance.now();const t=e=>{if(!this.running)return;let i=(e-this.last)/1e3;for(i>.25&&(i=.25),this.last=e,this.acc+=i;this.acc>=this.dt;)this.update(this.dt),this.acc-=this.dt;const o=this.acc/this.dt;this.render(o),requestAnimationFrame(t)};requestAnimationFrame(t)}stop(){this.running=!1}}async function m(s){const t=await fetch(s);if(!t.ok)throw new Error(`Failed to load ${s}: ${t.status}`);return t.json()}async function k(){const[s,t,e]=await Promise.all([m("/data/stations.json"),m("/data/segments.json"),m("/data/tuning.json")]);return{stations:s,segments:t,endpoints:e.line.endpoints,depotStationId:e.line.depotStationId}}class E{constructor(t){r(this,"ctx");r(this,"uiLayout");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Canvas 2D not supported");this.ctx=e,this.init()}async init(){this.uiLayout=await m("/data/uiLayout.json")}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,e,i,o){if(!this.uiLayout)return;this.ctx.strokeStyle=this.uiLayout.colors.hudBg,this.ctx.lineWidth=2;for(const a of e.segments){const h=e.stations.find(c=>c.id===a.fromId),d=e.stations.find(c=>c.id===a.toId);h&&d&&(this.ctx.beginPath(),this.ctx.moveTo(h.order*50+25,100),this.ctx.lineTo(d.order*50+25,100),this.ctx.stroke())}for(const a of e.stations)this.ctx.fillStyle=this.uiLayout.colors.hudBg,this.ctx.beginPath(),this.ctx.arc(a.order*50+25,100,this.uiLayout.sprites.station.r,0,2*Math.PI),this.ctx.fill();for(const a of t)if(a.state==="Running"){const h=e.segments[a.segmentIndex],d=e.stations.find(l=>l.id===h.fromId),c=e.stations.find(l=>l.id===h.toId);if(d&&c){const l=(d.order+(c.order-d.order)*(1-a.nextEventTime/h.travelSec))*50+25;this.ctx.fillStyle=a===i?this.uiLayout.colors.warning:this.uiLayout.colors.ok,this.ctx.fillRect(l-this.uiLayout.sprites.train.w/2,100-this.uiLayout.sprites.train.h/2,this.uiLayout.sprites.train.w,this.uiLayout.sprites.train.h)}}if(i){const a=this.uiLayout.hud.actions;for(let h=0;h<a.order.length;h++){const d=a.order[h],c=this.canvas.width+a.x-(a.order.length-h)*(a.buttonSize+a.gap),l=this.canvas.height+a.y-a.buttonSize;this.ctx.fillStyle=this.uiLayout.colors.hudBg,this.ctx.fillRect(c,l,a.buttonSize,a.buttonSize),this.ctx.fillStyle=this.uiLayout.colors.hudText,this.ctx.font="12px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(d,c+a.buttonSize/2,l+a.buttonSize/2)}}const n=this.uiLayout.hud.satisfaction;this.ctx.fillStyle=this.uiLayout.colors.hudBg,this.ctx.fillRect(n.x,n.y,n.width,n.height),this.ctx.fillStyle=this.uiLayout.colors.ok,this.ctx.fillRect(n.x,n.y,n.width*(o/100),n.height),this.ctx.fillStyle=this.uiLayout.colors.hudText,this.ctx.font="12px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`Satisfaction: ${o.toFixed(0)}%`,n.x+n.width/2,n.y+n.height/2)}drawEndDayReport(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.uiLayout.colors.hudText,this.ctx.font="32px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("End of Day",this.canvas.width/2,this.canvas.height/2-50),this.ctx.font="24px sans-serif",this.ctx.fillText(`Final Satisfaction: ${t.toFixed(0)}%`,this.canvas.widh/2,this.canvas.height/2);const e=t>=60?"You Win!":"You Lose!";this.ctx.font="48px sans-serif",this.ctx.fillStyle=t>=60?this.uiLayout.colors.ok:this.uiLayout.colors.danger,this.ctx.fillText(e,this.canvas.width/2,this.canvas.height/2+50)}}class R{constructor(t){r(this,"seed");this.seed=t>>>0}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}nextInt(t){return Math.floor(this.next()*t)}range(t,e){return t+(e-t)*this.next()}}class B{constructor(){r(this,"q",[])}push(t){this.q.push(t),this.q.sort((e,i)=>e.t-i.t)}peek(){return this.q[0]}pop(){return this.q.shift()}clear(){this.q.length=0}get size(){return this.q.length}}const S=new Set;function T(s){return S.has(s)}function p(s){S.add(s)}function v(s){S.delete(s)}function D(s,t,e){if(s.state==="Running"&&(s.nextEventTime-=e,s.nextEventTime<=0)){t.segments[s.segmentIndex];const i=s.segmentIndex+s.dir,o=t.segments[i];if(o)T(i)||(v(s.segmentIndex),p(i),s.segmentIndex=i,s.nextEventTime=o.travelSec);else{s.dir*=-1;const n=s.segmentIndex+s.dir;T(n)||(v(s.segmentIndex),p(n),s.segmentIndex=n,s.nextEventTime=t.segments[s.segmentIndex].travelSec)}}}function P(s,t,e,i,o,n){const a=e+i*(s+t);return Math.max(o,Math.min(n,a))}function z(s,t,e,i,o){const n=s.passengers.filter(u=>u.destId===t.id);s.passengers=s.passengers.filter(u=>u.destId!==t.id);const a=n.length;s.onboard-=a;const h=e.filter(u=>{const f=o.stations.find(x=>x.id===u.originId),g=o.stations.find(x=>x.id===u.destId);return!f||!g?!1:(g.order-f.order)*s.dir>0}),d=s.capacityCrush-s.onboard,c=Math.min(h.length,d),l=h.slice(0,c);for(const u of l){u.state="OnTrain",s.passengers.push(u);const f=e.indexOf(u);f>-1&&e.splice(f,1)}s.onboard+=l.length;const y=P(l.length,a,i.dwell.baseSec,i.dwell.perPaxSec,i.dwell.minSec,i.dwell.maxSec);s.state="Dwell",s.nextEventTime=y}let M=0;function O(s,t,e,i,o,n){const a=s.type,h=e.spawn.basePerMin[a]/60,d=F(e.spawn.curve,o),c=i.next(e.spawn.tickNoiseUniform[0],e.spawn.tickNoiseUniform[1]),l=h*d*c,y=Math.floor(l*n),u=[],f=t.stations.map(g=>g.id);for(let g=0;g<y;g++){let x=s.id;for(;x===s.id;)x=f[Math.floor(i.next(0,f.length))];u.push({id:M++,originId:s.id,destId:x,frustration:0,state:"Queue"})}return u}function F(s,t){for(const e of s.segments)if(t>=e.t0&&t<=e.t1){const i=(t-e.t0)/(e.t1-e.t0);return e.v0+i*(e.v1-e.v0)}return 0}class q{constructor(t,e){this.tuning=t,this.rng=e}update(t,e,i){for(const o of t)if(o.state==="Running"){const n=.6*e/60;if(this.rng.next(0,1)<n*i){o.state="Breakdown";const a=this.rng.next(this.tuning.hazard.durationSecRange[0],this.tuning.hazard.durationSecRange[1]);o.nextEventTime=a,p(o.segmentIndex)}}else o.state==="Breakdown"&&(o.nextEventTime-=i,o.nextEventTime<=0&&(o.state="Removed",v(o.segmentIndex)))}}class C{constructor(t,e){this.tuning=t,this.rng=e}applyDelays(t,e){for(const i of t)i.state==="Running"?this.rng.next(0,1)<.1*e&&(i.nextEventTime*=this.tuning.delays.speedFactor):i.state==="Dwell"&&this.rng.next(0,1)<.1*e&&(i.nextEventTime*=this.tuning.delays.dwellFactor)}}function A(s){return Math.max(0,100-s)}function Q(s,t,e){for(const i of s)i.state==="Queue"?i.frustration+=t.frustration.waitingPerSec*e:i.state==="OnTrain"&&(i.frustration-=t.frustration.onTrainDecayPerSec*e)}class N{constructor(t){r(this,"renderer");r(this,"tick",0);r(this,"rng",new R(1337));r(this,"tuning");r(this,"line");r(this,"trains",[]);r(this,"passengers",[]);r(this,"stationQueues",new Map);r(this,"eventQueue",new B);r(this,"dayTime",0);r(this,"selectedTrain",null);r(this,"breakdownSystem");r(this,"delaySystem");r(this,"satisfaction",100);r(this,"isDayOver",!1);this.canvas=t,this.renderer=new E(t),this.init(),this.canvas.addEventListener("click",this.handleClick.bind(this))}async init(){this.tuning=await m("/data/tuning.json"),this.line=await k(),this.breakdownSystem=new q(this.tuning,this.rng),this.delaySystem=new C(this.tuning,this.rng);for(const t of this.line.stations)this.stationQueues.set(t.id,[]);for(let t=0;t<this.tuning.line.maxTrains;t++){const e=t*2,i={id:t,state:"Running",dir:1,segmentIndex:e,onboard:0,passengers:[],capacityNominal:this.tuning.capacity.nominal,capacityCrush:this.tuning.capacity.crush,nextEventTime:this.line.segments[e].travelSec};this.trains.push(i),p(e)}}update(t){if(this.isDayOver)return;this.tick++,this.dayTime+=t;const e=this.dayTime/this.tuning.sim.dayLengthSec;for(const i of this.line.stations){const o=O(i,this.line,this.tuning,this.rng,e,t);this.passengers.push(...o),this.stationQueues.get(i.id).push(...o)}Q(this.passengers,this.tuning,t),this.breakdownSystem.update(this.trains,e,t),this.delaySystem.applyDelays(this.trains,t);for(const i of this.trains)if(i.state==="Running"){if(D(i,this.line,t),i.nextEventTime<=0){const o=this.line.segments[i.segmentIndex],n=this.line.stations.find(a=>a.id===o.toId);n&&z(i,n,this.stationQueues.get(n.id),this.tuning,this.line)}}else i.state==="Dwell"&&(i.nextEventTime-=t,i.nextEventTime<=0&&(i.state="Running"));this.dayTime>=this.tuning.sim.dayLengthSec&&this.endDay()}render(t){this.renderer.clear(),this.renderer.draw(this.trains,this.line,this.selectedTrain,this.satisfaction),this.isDayOver&&this.renderer.drawEndDayReport(this.satisfaction)}handleClick(t){const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top;for(const n of this.trains){const a=this.line.segments[n.segmentIndex],h=this.line.stations.find(c=>c.id===a.fromId),d=this.line.stations.find(c=>c.id===a.toId);if(h&&d){const c=(h.order+(d.order-h.order)*(1-n.nextEventTime/a.travelSec))*50+25;if(i>=c-24&&i<=c+24&&o>=92&&o<=108){this.selectedTrain=n;return}}}if(this.selectedTrain){const n=this.tuning.hud.actions;for(let a=0;a<n.order.length;a++){const h=n.order[a],d=this.canvas.width+n.x-(n.order.length-a)*(n.buttonSize+n.gap),c=this.canvas.height+n.y-n.buttonSize;if(i>=d&&i<=d+n.buttonSize&&o>=c&&o<=c+n.buttonSize){this.handleAction(h);return}}}this.selectedTrain=null}handleAction(t){if(this.selectedTrain){switch(t){case"reverse":this.selectedTrain.dir*=-1;break;case"skip":break;case"cancel":break;case"forceEmpty":this.selectedTrain.passengers=[],this.selectedTrain.onboard=0;break}this.selectedTrain=null}}endDay(){let t=0;for(const i of this.passengers)t+=i.frustration;const e=this.passengers.length>0?t/this.passengers.length:0;this.satisfaction=A(e),this.isDayOver=!0}}const j=document.getElementById("view"),$=document.getElementById("tick"),w=new N(j),Y=new L({update:s=>{w.update(s),$.textContent=`tick: ${w.tick}`},render:s=>w.render(s),simHz:20});Y.start();
//# sourceMappingURL=index-B0__hx8H.js.map
